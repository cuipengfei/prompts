# Design: add-debate-plugin

## 设计哲学

### 核心洞察

**SOTA 模型不需要教如何辩论** - 它们已经知道。我们只需要：
1. 设置场景（辩论主题）
2. 建立角色（批判性思考伙伴）
3. 提供机制（Task + resume 连续对话）

### 与传统辩论系统的对比

| 传统方法 | 本设计 |
|----------|--------|
| 预设轮数（3轮、5轮） | 自然发展，无限制 |
| 正方/反方固定角色 | 批判性思考伙伴，灵活 |
| 复杂状态机 | 简单 resume 机制 |
| 详细辩论规则 | 信任模型能力 |
| 胜负判定 | 目标是发现更好答案 |

## 架构

### 组件关系

```
/debate command
    ↓
dialectic-partner skill (设置子代理角色)
    ↓
Task tool (启动子代理)
    ↓
resume (多轮对话)
```

### 数据流

```
用户输入 topic
    ↓
主代理评估可用 subagent types
    ↓
主代理陈述初始观点
    ↓
Task(prompt: "质疑这个观点...", subagent_type: [动态选择])
    ↓
子代理返回质疑 + agentId
    ↓
主代理回应质疑
    ↓
Task(resume: agentId, prompt: "继续质疑...")
    ↓
... 循环直到达成共识
```

## 关键设计决策

### 决策 1：动态选择 subagent_type

**选择**：主代理根据辩论主题从可用代理中智能选择最合适的类型

**理由**：
- 不同主题适合不同专业代理
- 主代理已知可用的 subagent types（在 system prompt 中）
- 智能匹配比硬编码更灵活

**实现**：skill 指导主代理在启动辩论前评估可用代理并选择最匹配的

**失败回退**：
- 如选择的代理不可用或响应异常，回退到 `general-purpose`
- 选择过程应在辩论记录中留痕（选了谁，为什么）

### 决策 2：子代理需要具体上下文

**选择**：启动辩论时，主代理必须收集并提供具体上下文给子代理

**理由**：
- 子代理无法访问主代理的会话历史
- 没有具体上下文，子代理只能泛泛而谈
- 基于事实的辩论比抽象讨论更有价值

**上下文类型**：

| 辩论类型 | 应提供的上下文 |
|----------|----------------|
| 代码设计 | 文件路径、关键代码片段 |
| 架构决策 | 相关文件结构、依赖关系 |
| PR 审查 | 变更文件列表、告知子代理运行 git diff |
| 文档质量 | 文档内容摘要或完整内容 |

**实现**：主代理在 Task prompt 中包含：
- 具体文件路径（子代理可自行读取）
- 或关键内容摘要（如文件太大）
- 代码变更提供变更文件列表，并告知子代理运行 git diff
- 说明"若上下文不足，请自主寻找并报告"

**示例**：
```
Task prompt: "请审查以下设计决策：
文件：/mnt/d/code/prompts/openspec/changes/add-debate-plugin/design.md
关键内容：[决策1-5摘要]
请质疑这些决策的合理性。"
```

### 决策 3：角色通过 prompt 建立

**选择**：在 Task 的 prompt 中描述角色，而非 skill 配置

**理由**：
- 更灵活，可根据辩论主题调整
- 不需要修改 Claude Code 核心
- skill 只提供指导原则

### 决策 4：主代理控制辩论流程

**选择**：主代理负责判断何时继续、何时总结、何时结束

**理由**：
- 主代理有完整上下文
- 用户可以随时介入
- 避免无限循环

**Soft Limit**：
- 10 轮后主代理应主动建议总结（不强制结束，而是提醒）
- 防止辩论无限拉扯

### 决策 5：用户全程参与

**选择**：通过 AskUserQuestion 让用户在辩论全程参与，而非仅观察

**理由**：
- 用户是辩论的发起者和最终决策者
- 用户可能有代理不知道的上下文
- 辩论是为用户服务，不是代理自娱自乐

**参与时机**：

| 阶段 | AskUserQuestion 用途 |
|------|----------------------|
| 开始前 | 确认主题、初始倾向、关注重点 |
| 每轮后 | 继续/引导方向/加入观点/请求深入 |
| 关键分歧 | 提供额外上下文或表态 |
| 结束时 | 是否保留记录 |

**选项示例**（每轮后）：
- "继续辩论" - 让代理继续
- "我想补充..." - 用户加入新信息
- "深入讨论 X" - 引导方向
- "总结并结束" - 结束辩论

**平衡**：不强制每轮都问，让主代理判断何时需要用户输入（如分歧较大、需要决策时）

**用户跳过选项**：
- AskUserQuestion 选项中应包含"让代理自行决定"或"继续辩论"
- 用户可选择此项让主代理自行推进，避免每轮都必须做决策

### 决策 6：辩论历史实时持久化

**选择**：每轮结束后立即更新 Markdown 文件，而非等到辩论结束

**理由**：
- **防止上下文丢失** - 长对话可能导致代理遗忘早期内容
- **实时备份** - 即使会话中断，辩论记录不丢失
- **可重新读取** - 如上下文过长，代理可从文件恢复
- **用户可实时查看** - 用户可随时打开文件查看进度

**实现**：
1. 辩论开始时创建文件（含元数据）
2. 每轮结束后追加该轮内容
3. 辩论结束时追加结论
4. 最后询问用户是否保留

**存储**：`.debates/YYYY-MM-DD-topic-slug.md`

**格式**：
```markdown
# Debate: [主题]

**Date**: 2026-01-25
**Status**: in-progress | completed
**Participants**: Main Agent ↔ Sub Agent ([agent-type])
**Outcome**: (辩论结束后填写)

---

## Round 1

### Main Agent
[观点]

### Sub Agent
[质疑]

### User Input (如有)
[用户补充]

---

## Round 2
... (实时追加)

---

## Conclusion (辩论结束后追加)

### Key Insights
- ...

### User's Decision
- ...
```

**删除流程**：
- 辩论结束后询问用户
- 如选择不保留 → 删除文件
- 如选择保留 → 更新 Status 为 completed

### 决策 7：主代理隔离原则

**选择**：主代理不得在用户同意前根据子代理建议修改代码或文件

**理由**：
- **防止污染** - 子代理的建议可能有偏差或错误，不应自动采纳
- **用户控制** - 用户是最终决策者，所有修改需经用户同意
- **信任边界** - 辩论是探索过程，不是执行过程

**硬性规则**：
- 主代理只能**展示**子代理的建议，不能**执行**
- 任何代码/文件修改必须先获得用户明确同意
- 违反此规则视为严重错误

## Skill 内容设计

### 技术参考

使用 Task + resume 机制确保子代理保持对话上下文：

- **主代理**：在主会话中，上下文自然保持，无需特殊处理
- **子代理**：通过 resume 参数传入 agentId，保持多轮对话连续性

关键点：
- 保存首轮返回的 agentId
- 后续轮次用 resume 参数继续
- 前台/后台模式可自由切换
- **agentId 仅限当前会话有效**，会话结束后失效
- **跨会话续辩**：通过读取 `.debates/*.md` 历史文件恢复上下文，而非依赖 agentId

详见 `subagent-continuous-conversation.md`。

### 简洁原则

skill 应信任模型能力，不教模型如何辩论，但可提供操作机制：
1. 模型已知道好辩论的特征（无需辩论技巧教程）
2. 操作流程和机制说明是必要的（如 Task + resume、记录持久化）
3. 过度限制规则反而削弱灵活性

### 核心内容

1. **目的说明** - 辩论的目标是什么（发现盲点，不是赢）
2. **角色建立** - 子代理是"dialectic partner"
3. **质量标准** - 什么是好的质疑（有建设性，不是抬杠）
4. **操作流程** - 如何使用 Task + resume、AskUserQuestion、记录持久化
5. **隔离原则** - 主代理不得在用户同意前执行子代理建议

### 不需要包含

- 辩论技巧教程
- 逻辑谬误清单
- 评分标准

## 边界情况

### 用户提供模糊主题

```
用户: /debate
```

→ 主代理应询问具体辩论主题

### 辩论陷入僵局

→ 主代理可主动提出寻找共同点或总结分歧

### 用户中途改变方向

→ 正常响应，辩论主题可随用户需求调整

## 后续扩展可能

> 当前不实现，仅记录思路

- 辩论总结导出
- 多个子代理参与（三方辩论）
- 特定领域的辩论模板
