---
name: codex-advisor
description: 调用 OpenAI Codex 获取第二意见，批判性评估后三分类展示给用户
---

# Codex 顾问技能

调用 OpenAI Codex MCP 获取代码审查或第二意见，对结果进行批判性评估，过滤 nitpick 和 over-engineering，然后结构化展示给用户。

## 执行步骤

### 第一步：推断用户意图

根据上下文自动推断场景：

| 上下文特征 | 推断场景 | 处理方式 |
|-----------|----------|----------|
| 有文件引用 (`@file`) | 代码审查 | 让 Codex 审查指定文件 |
| 有 git diff 上下文 | 变更审查 | 将 diff 嵌入请求 |
| 问句形式 | 第二意见 | 构建开放性咨询请求 |
| 无明确目标 | 整体评估 | 评估最近的工作 |

### 第二步：收集上下文

1. **获取项目目录**：当前工作目录
2. **提取项目规则**：读取 CLAUDE.md 中的关键规则（如有）
3. **准备内容**：
   - 如有文件引用：读取文件内容
   - 如有 git diff：执行 `git diff` 获取变更
   - 如有代码片段：从用户参数提取

### 第三步：构建 Codex 请求

调用 Codex MCP：

```
mcp__codex-mcp__codex
- prompt: [构建的请求，包含上下文和具体问题]
- cwd: [当前项目目录]
- sandbox: read-only
- base-instructions: [从 CLAUDE.md 提取的项目规则，如有]
```

**Prompt 模板**：
```
请审查以下内容并提供反馈：

[上下文：文件内容/git diff/代码片段]

请关注：
1. 潜在的 bug 或逻辑问题
2. 性能问题
3. 安全隐患
4. 可改进的设计

注意：请聚焦于有实际价值的建议，避免纯风格偏好的 nitpick。
```

### 第四步：批判性评估 Codex 结果

⚠️ **关键**：不盲目信任 Codex 结果。必须评估每条建议。

#### Nitpick 判断标准（过滤）

以下情况判定为 nitpick，分类到"已过滤"：
- 仅涉及风格偏好（如空格、命名风格）且与项目现有风格不一致
- 改动收益 < 改动成本
- 纯粹的个人偏好，无功能性影响
- 建议与项目 CLAUDE.md 中的规范冲突

#### Over-engineering 判断标准（过滤）

以下情况判定为 over-engineering，分类到"已过滤"：
- 引入不必要的抽象层（如为单一用例创建接口）
- 为未来可能的需求预设设计（YAGNI 原则）
- 显著增加复杂度但收益不明确
- 建议重构规模与问题严重性不匹配

#### 有价值判断标准（采纳）

以下情况判定为有价值，分类到"采纳建议"：
- 发现实际 bug 或逻辑错误
- 发现性能问题（有具体证据）
- 发现安全隐患
- 提供更简洁的实现方式
- 改进与项目现有模式一致

#### 需讨论判断标准

以下情况分类到"需讨论"：
- 建议有一定价值但需要权衡
- 涉及架构决策，需用户判断
- 改动影响范围较大，需确认意图

### 第五步：结构化展示

按三分类格式展示结果：

```markdown
## Codex 反馈评估

### ✅ 采纳建议（有价值）
- **[建议标题]**: [建议内容]
  - 📌 采纳理由：[为什么这个建议有价值]

### 💬 需讨论（可能有价值）
- **[建议标题]**: [建议内容]
  - 🤔 讨论点：[为什么需要用户决定]

### ⏭️ 已过滤（nitpick/over-engineering）
- **[建议标题]**: [建议内容]
  - 🚫 过滤原因：[nitpick/over-engineering + 具体解释]

---

**你想要采纳哪些建议？** 回复编号或描述你的选择。
```

### 第六步：执行用户选择

根据用户回复：
- 如果用户选择采纳某些建议：帮助实现这些建议
- 如果用户想讨论某些建议：提供更多分析
- 如果用户不采纳任何建议：确认并结束

## Codex MCP 工具参考

```
# 启动新 Codex 会话
mcp__codex-mcp__codex
- prompt: string (必需) - 初始请求
- cwd: string (可选) - 工作目录
- sandbox: "read-only" | "workspace-write" | "danger-full-access"
- base-instructions: string (可选) - 覆盖默认指令
- model: string (可选) - 模型选择 (o3, o4-mini)

# 继续现有会话
mcp__codex-mcp__codex-reply
- conversationId: string (必需) - 会话 ID
- prompt: string (必需) - 后续请求
```

## 边界情况

### Codex 无响应或报错
```markdown
⚠️ Codex 调用失败

错误信息：[具体错误]

可能原因：
- Codex MCP 服务器未启动
- 网络问题
- API 配额用尽

建议：检查 Codex MCP 配置后重试，或直接描述你想获取的反馈。
```

### Codex 返回空结果
```markdown
Codex 审查完成，未发现需要改进的地方。

这可能意味着：
- 代码质量良好
- 或者需要更具体的审查方向

你想让我针对特定方面再次咨询 Codex 吗？
```

### 所有建议都被过滤
```markdown
## Codex 反馈评估

Codex 提供了 [X] 条建议，经评估后全部被过滤：

### ⏭️ 已过滤（nitpick/over-engineering）
[列出被过滤的建议和原因]

---

**结论**：Codex 的建议主要是 nitpick 或 over-engineering，当前代码无需修改。

如果你认为某些建议可能有价值，请告诉我，我会重新评估。
```
